<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fest Photo Booth</title>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            color: white; 
            font-family: sans-serif; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
        }

        /* Kameran täcker hela bakgrunden */
        #camera-container { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        video { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
        }

        /* Den osynliga knappen som täcker ALLT */
        #btn-capture { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0); /* Helt transparent */
            border: none;
            cursor: pointer;
            z-index: 10; /* Ligger överst */
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 40px;
        }

        /* Hjälptext som syns när kameran är redo */
        #hint-text {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50px;
            pointer-events: none; /* Texten stör inte klicket */
        }

        #countdown { 
            position: absolute; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 250px; font-weight: bold; 
            text-shadow: 0 0 30px rgba(0,0,0,0.8); 
            z-index: 100;
            pointer-events: none;
        }

        #flash { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; opacity: 0; pointer-events: none; z-index: 200;
        }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="preview" autoplay playsinline></video>
</div>

<button id="btn-capture">
    <span id="hint-text">Tryck var som helst för att ta bild</span>
</button>

<div id="countdown"></div>
<div id="flash"></div>

<canvas id="photo-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('preview');
    const canvas = document.getElementById('photo-canvas');
    const countdownEl = document.getElementById('countdown');
    const flash = document.getElementById('flash');
    const btn = document.getElementById('btn-capture');
    const hintText = document.getElementById('hint-text');

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwaC1SrZFqlMndjBRk6aVJY5pBr3TAkyMJr48Xz_YxiUEL7mDiYdlJenyRGwuxBPd4mwg/exec";

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user", width: { ideal: 1920 }, height: { ideal: 1080 } }
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Kameran kunde inte startas.");
        }
    }

    function enableFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {});
        }
    }

    async function takePhoto() {
        enableFullScreen();
        
        // Inaktivera klick under processen
        btn.style.pointerEvents = 'none';
        hintText.style.opacity = '0';
        
        // Nedräkning
        for (let i = 3; i > 0; i--) {
            countdownEl.innerText = i;
            await new Promise(r => setTimeout(r, 1000));
        }
        countdownEl.innerText = "SMILE!";
        await new Promise(r => setTimeout(r, 400));
        countdownEl.innerText = "";

        // Blixt
        flash.style.opacity = 1;
        setTimeout(() => flash.style.opacity = 0, 150);

        // Fånga bild
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL('image/jpeg', 0.85);
        
        // Skicka
        const base64Clean = imageData.split(',')[1];
        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ image: base64Clean, filename: "fest_" + Date.now() + ".jpg" })
        });
        
        // Återställ efter paus
        setTimeout(() => {
            btn.style.pointerEvents = 'auto';
            hintText.style.opacity = '1';
        }, 3000);
    }

    btn.addEventListener('click', takePhoto);
    initCamera();
</script>
</body>
</html>