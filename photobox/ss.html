<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Säkert Bildspel - Photo Booth</title>
    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: sans-serif; }
        #main-display { position: absolute; top: 0; left: 0; width: 100%; height: 80vh; display: flex; align-items: center; justify-content: center; }
        #main-img { max-width: 95%; max-height: 95%; object-fit: contain; border: 10px solid #fff; box-shadow: 0 0 50px rgba(255,255,255,0.2); transition: opacity 0.8s; opacity: 0; }
        #grid-display { position: absolute; bottom: 0; width: 100%; height: 20vh; display: flex; gap: 10px; padding: 10px; background: #111; overflow: hidden; justify-content: center; }
        .grid-item { height: 90%; aspect-ratio: 1; background-size: cover; background-position: center; border: 2px solid #444; }
        #loader { position: fixed; top: 10px; right: 10px; font-size: 12px; color: #555; }
    </style>
</head>
<body>

<div id="loader">Uppdaterar...</div>
<div id="main-display">
    <img id="main-img" src="" alt="Slideshow">
</div>
<div id="grid-display"></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgPBkkd2rR7oePF91BeOGBu5cQlZ4SropIG-axnG9aiEqoKGLESR14uW1ALM9M-SUi-w/exec";
    let imageIds = [];
    const mainImg = document.getElementById('main-img');
    const gridDisplay = document.getElementById('grid-display');

    async function fetchImageList() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            imageIds = data;
            updateGrid();
        } catch (e) { console.error("Kunde inte hämta lista", e); }
    }

    async function updateGrid() {
        gridDisplay.innerHTML = '';
        // Visa de senaste 8 i mosaiken
        const recent = imageIds.slice(0, 8);
        for (let imgInfo of recent) {
            const div = document.createElement('div');
            div.className = 'grid-item';
            // Vi hämtar en tumnagel via proxyn
            const imgData = await fetchImageData(imgInfo.id);
            div.style.backgroundImage = `url(data:${imgData.contentType};base64,${imgData.base64})`;
            gridDisplay.appendChild(div);
        }
    }

    async function fetchImageData(id) {
        const res = await fetch(`${SCRIPT_URL}?fileId=${id}`);
        return await res.json();
    }

    async function showNext() {
        if (imageIds.length === 0) return;

        // Välj bild (70% chans på topp 5)
        let id;
        if (Math.random() < 0.7 && imageIds.length >= 5) {
            id = imageIds[Math.floor(Math.random() * 5)].id;
        } else {
            id = imageIds[Math.floor(Math.random() * imageIds.length)].id;
        }

        const imgData = await fetchImageData(id);
        mainImg.style.opacity = 0;
        setTimeout(() => {
            mainImg.src = `data:${imgData.contentType};base64,${imgData.base64}`;
            mainImg.style.opacity = 1;
        }, 800);
    }

    // Starta
    fetchImageList();
    setInterval(fetchImageList, 30000); // Kolla efter nya bilder var 30:e sek
    setInterval(showNext, 7000); // Byt bild var 7:e sek
</script>
</body>
</html>